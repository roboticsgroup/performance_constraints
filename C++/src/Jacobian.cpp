/*This is a demo of Performance Constraints for a robotic manipulator.
The KUKA LWR 4+ is provided as an example here.

A description and the overall algorithm of the method is in:
- Dimeas, Fotios, Vassilis C. Moulianitis, and Nikos Aspragathos. 
"Manipulator performance constraints in human-robot cooperation." 
Robotics and Computer-Integrated Manufacturing (2017).

In here we calculate the Jacobian matrix (6x7) for the KUKA LWR manipulator (expressed at the tool frame)
The calculations are derived from Matlab symbolic toolbox and Ccode creator.

UPDATE 06/2020: Fixed some discrepancies in the Jacobian

Author: Fotis Dimeas
Copyright 2020 Fotios Dimeas
*/

#include "performanceConstraints.h"

//Jacobian expressed on the tool frame
void PC::get_Jsym_body(const arma::vec jntvalues, arma::mat& J) {
	
	double t1 = jntvalues.at(0);
	double t2 = jntvalues.at(1);
	double t3 = jntvalues.at(2);
	double t4 = jntvalues.at(3);
	double t5 = jntvalues.at(4);
	double t6 = jntvalues.at(5);
	double t7 = jntvalues.at(6);

	double t9 = cos(t7);
	double t10 = cos(t4);
	double t11 = sin(t5);
	double t12 = sin(t7);
	double t13 = t11*t12;
	double t14 = cos(t5);
	double t15 = cos(t6);
	double t20 = t9*t14*t15;
	double t16 = t13-t20;
	double t17 = sin(t4);
	double t18 = sin(t6);
	double t19 = sin(t3);
	double t21 = t10*t16;
	double t39 = t9*t17*t18;
	double t22 = t21-t39;
	double t23 = cos(t3);
	double t24 = t12*t14;
	double t25 = t9*t11*t15;
	double t26 = t24+t25;
	double t27 = cos(t1);
	double t28 = cos(t2);
	double t29 = sin(t2);
	double t30 = t15*(3.9E1/5.0E2);
	double t31 = t30+3.9E1/1.0E2;
	double t32 = sin(t1);
	double t33 = t17*t31;
	double t47 = t10*t14*t18*(3.9E1/5.0E2);
	double t34 = t33-t47;
	double t35 = t16*t17;
	double t36 = t9*t10*t18;
	double t37 = t35+t36;
	double t38 = t29*t37;
	double t40 = t22*t23;
	double t41 = t19*t26;
	double t42 = t40+t41;
	double t43 = t28*t42;
	double t44 = t38+t43;
	double t45 = t19*t22;
	double t89 = t23*t26;
	double t46 = t45-t89;
	double t48 = t19*t34;
	double t59 = t11*t18*t23*(3.9E1/5.0E2);
	double t49 = t48-t59;
	double t50 = t23*t34;
	double t51 = t11*t18*t19*(3.9E1/5.0E2);
	double t52 = t50+t51;
	double t53 = t10*t31;
	double t54 = t14*t17*t18*(3.9E1/5.0E2);
	double t55 = t53+t54+2.0/5.0;
	double t57 = t28*t52;
	double t58 = t29*t55;
	double t56 = t57-t58;
	double t60 = t27*t49;
	double t61 = t32*t56;
	double t62 = t60+t61;
	double t63 = t9*t11;
	double t64 = t12*t14*t15;
	double t65 = t63+t64;
	double t66 = t10*t65;
	double t67 = t12*t17*t18;
	double t68 = t66+t67;
	double t69 = t9*t14;
	double t73 = t11*t12*t15;
	double t70 = t69-t73;
	double t71 = t32*t49;
	double t72 = t19*t68;
	double t92 = t23*t70;
	double t74 = t72-t92;
	double t75 = t17*t65;
	double t83 = t10*t12*t18;
	double t76 = t75-t83;
	double t77 = t29*t76;
	double t78 = t23*t68;
	double t79 = t19*t70;
	double t80 = t78+t79;
	double t81 = t28*t80;
	double t82 = t77+t81;
	double t84 = t29*t52;
	double t85 = t28*t55;
	double t86 = t84+t85;
	double t87 = t28*t37;
	double t88 = t87-t29*t42;
	double t90 = t28*t76;
	double t91 = t90-t29*t80;
	double t93 = t15*t17;
	double t94 = t93-t10*t14*t18;
	double t95 = t10*t15;
	double t96 = t14*t17*t18;
	double t97 = t95+t96;
	J.at(0,0) = (t71-t27*t56)*(t27*t46+t32*t44)+t62*(t27*t44-t32*t46);
	J.at(0,1) = t44*t86+t56*t88;
	J.at(0,2) = t9*t11*t17*(3.9E1/5.0E2)-t10*t12*t18*(3.9E1/5.0E2)+t12*t14*t17*(3.9E1/1.0E2)+t9*t11*t15*t17*(3.9E1/1.0E2)+t12*t14*t15*t17*(3.9E1/5.0E2);
	J.at(0,3) = t9*t14*(3.9E1/5.0E2)-t11*t12*(3.9E1/1.0E2)+t9*t14*t15*(3.9E1/1.0E2)-t11*t12*t15*(3.9E1/5.0E2);
	J.at(0,4) = t12*t18*(-3.9E1/5.0E2);
	J.at(0,5) = t9*(-3.9E1/5.0E2);
	J.at(1,0) = (t71-t27*t56)*(t27*t74+t32*t82)-t62*(t32*t74-t27*t82);
	J.at(1,1) = t56*t91+t82*t86;
	J.at(1,2) = t9*t10*t18*(-3.9E1/5.0E2)+t9*t14*t17*(3.9E1/1.0E2)-t11*t12*t17*(3.9E1/5.0E2)+t9*t14*t15*t17*(3.9E1/5.0E2)-t11*t12*t15*t17*(3.9E1/1.0E2);
	J.at(1,3) = t9*t11*(-3.9E1/1.0E2)-t12*t14*(3.9E1/5.0E2)-t9*t11*t15*(3.9E1/5.0E2)-t12*t14*t15*(3.9E1/1.0E2);
	J.at(1,4) = t9*t18*(-3.9E1/5.0E2);
	J.at(1,5) = t12*(3.9E1/5.0E2);
	J.at(2,0) = t11*t17*t18*t28*(-3.9E1/1.0E2)+t14*t18*t19*t29*(3.9E1/1.0E2)-t15*t17*t19*t29*(2.0/5.0)+t11*t18*t23*t29*(2.0/5.0)+t10*t14*t18*t19*t29*(2.0/5.0)+t10*t11*t18*t23*t29*(3.9E1/1.0E2);
	J.at(2,1) = t11*t18*t19*(-2.0/5.0)+t14*t18*t23*(3.9E1/1.0E2)-t15*t17*t23*(2.0/5.0)-t10*t11*t18*t19*(3.9E1/1.0E2)+t10*t14*t18*t23*(2.0/5.0);
	J.at(2,2) = t11*t17*t18*(-3.9E1/1.0E2);
	J.at(2,3) = t14*t18*(-3.9E1/1.0E2);
	J.at(3,0) = t88;
	J.at(3,1) = t46;
	J.at(3,2) = t37;
	J.at(3,3) = t26;
	J.at(3,4) = t9*t18;
	J.at(3,5) = -t12;
	J.at(4,0) = t91;
	J.at(4,1) = t74;
	J.at(4,2) = t76;
	J.at(4,3) = t70;
	J.at(4,4) = -t12*t18;
	J.at(4,5) = -t9;
	J.at(5,0) = t29*(t23*t94+t11*t18*t19)+t28*t97;
	J.at(5,1) = -t19*t94+t11*t18*t23;
	J.at(5,2) = t97;
	J.at(5,3) = -t11*t18;
	J.at(5,4) = t15;
	J.at(5,6) = 1.0;

}

//Jacobian expressed on the base frame
//// Simplified from Matlab
void PC::get_Jsym_spatial(const arma::vec jntvalues, arma::mat& J) {

	double t1 = jntvalues.at(0);
	double t2 = jntvalues.at(1);
	double t3 = jntvalues.at(2);
	double t4 = jntvalues.at(3);
	double t5 = jntvalues.at(4);
	double t6 = jntvalues.at(5);
	double t7 = jntvalues.at(6);

	double t9 = sin(t6);
	double t10 = cos(t3);
	double t11 = cos(t6);
	double t12 = sin(t4);
	double t13 = t11*t12;
	double t14 = cos(t4);
	double t15 = cos(t5);
	double t27 = t9*t14*t15;
	double t16 = t13-t27;
	double t17 = sin(t3);
	double t18 = sin(t5);
	double t19 = cos(t1);
	double t20 = cos(t2);
	double t21 = sin(t2);
	double t22 = t11*(3.9E1/5.0E2);
	double t23 = t22+3.9E1/1.0E2;
	double t24 = sin(t1);
	double t25 = t12*t23;
	double t37 = t9*t14*t15*(3.9E1/5.0E2);
	double t26 = t25-t37;
	double t28 = t16*t17;
	double t47 = t9*t10*t18;
	double t29 = t28-t47;
	double t30 = t10*t16;
	double t31 = t9*t17*t18;
	double t32 = t30+t31;
	double t33 = t11*t14;
	double t34 = t9*t12*t15;
	double t35 = t33+t34;
	double t49 = t20*t32;
	double t50 = t21*t35;
	double t36 = t49-t50;
	double t38 = t17*t26;
	double t64 = t9*t10*t18*(3.9E1/5.0E2);
	double t39 = t38-t64;
	double t40 = t10*t26;
	double t41 = t9*t17*t18*(3.9E1/5.0E2);
	double t42 = t40+t41;
	double t43 = t14*t23;
	double t44 = t9*t12*t15*(3.9E1/5.0E2);
	double t45 = t43+t44+2.0/5.0;
	double t62 = t20*t42;
	double t63 = t21*t45;
	double t46 = t62-t63;
	double t48 = t24*t29;
	double t111 = t19*t36;
	double t51 = t48-t111;
	double t52 = cos(t7);
	double t53 = sin(t7);
	double t54 = t18*t53;
	double t56 = t11*t15*t52;
	double t55 = t54-t56;
	double t57 = t14*t55;
	double t71 = t9*t12*t52;
	double t58 = t57-t71;
	double t59 = t15*t53;
	double t60 = t11*t18*t52;
	double t61 = t59+t60;
	double t65 = t24*t39;
	double t105 = t19*t46;
	double t66 = t65-t105;
	double t67 = t12*t55;
	double t68 = t9*t14*t52;
	double t69 = t67+t68;
	double t70 = t21*t69;
	double t72 = t10*t58;
	double t73 = t17*t61;
	double t74 = t72+t73;
	double t75 = t20*t74;
	double t76 = t70+t75;
	double t77 = t10*t61;
	double t78 = t19*t39;
	double t79 = t24*t46;
	double t80 = t78+t79;
	double t83 = t17*t58;
	double t81 = t77-t83;
	double t82 = t19*t76;
	double t84 = t18*t52;
	double t85 = t11*t15*t53;
	double t86 = t84+t85;
	double t87 = t14*t86;
	double t88 = t9*t12*t53;
	double t89 = t87+t88;
	double t90 = t15*t52;
	double t96 = t11*t18*t53;
	double t91 = t90-t96;
	double t92 = t12*t86;
	double t108 = t9*t14*t53;
	double t93 = t92-t108;
	double t94 = t21*t93;
	double t95 = t10*t89;
	double t97 = t17*t91;
	double t98 = t95+t97;
	double t99 = t20*t98;
	double t100 = t94+t99;
	double t101 = t19*t100;
	double t102 = t10*t91;
	double t106 = t17*t89;
	double t107 = t102-t106;
	double t103 = t24*t107;
	double t104 = t101+t103;
	double t109 = t24*(t77-t83);
	double t110 = t82+t109;
	double t112 = t21*t42;
	double t113 = t20*t45;
	double t114 = t112+t113;
	double t115 = t11*t14*t15*t52;
	double t120 = t14*t18*t53;
	double t116 = t71+t115-t120;
	double t117 = t14*t18*t52;
	double t118 = t11*t14*t15*t53;
	double t119 = t88+t117+t118;
	double t121 = t17*t116;
	double t122 = t77+t121;
	double t123 = t24*t122;
	double t124 = t12*t18*t53;
	double t178 = t11*t12*t15*t52;
	double t125 = t68+t124-t178;
	double t126 = t21*t125;
	double t179 = t10*t116;
	double t212 = t73-t179;
	double t127 = t20*t212;
	double t128 = t126+t127;
	double t129 = t19*t128;
	double t130 = t123+t129;
	double t185 = t17*t119;
	double t131 = t102-t185;
	double t132 = t24*t131;
	double t133 = t12*t18*t52;
	double t134 = t11*t12*t15*t53;
	double t135 = -t108+t133+t134;
	double t136 = t21*t135;
	double t137 = t10*t119;
	double t138 = t97+t137;
	double t139 = t20*t138;
	double t140 = t136+t139;
	double t141 = t19*t140;
	double t142 = t9*t14*t15*t17;
	double t190 = t11*t12*t17;
	double t143 = t47+t142-t190;
	double t144 = t10*t11*t12;
	double t191 = t9*t10*t14*t15;
	double t145 = t31+t144-t191;
	double t192 = t20*t145;
	double t146 = t50-t192;
	double t147 = t19*t146;
	double t148 = t19*t29;
	double t149 = t24*t36;
	double t150 = t148+t149;
	double t151 = t51*t80;
	double t208 = t66*t150;
	double t152 = t151-t208;
	double t153 = t19*t81;
	double t155 = t24*t76;
	double t154 = t153-t155;
	double t156 = t66*t154;
	double t157 = t24*t100;
	double t159 = t19*t107;
	double t158 = t157-t159;
	double t160 = t80*t104;
	double t161 = t66*t158;
	double t162 = t160+t161;
	double t163 = t76*t114;
	double t164 = t20*t69;
	double t209 = t21*t74;
	double t165 = t164-t209;
	double t166 = t46*t165;
	double t167 = t163+t166;
	double t168 = t21*t32;
	double t169 = t20*t35;
	double t170 = t168+t169;
	double t171 = t36*t114;
	double t211 = t46*t170;
	double t172 = t171-t211;
	double t173 = t100*t114;
	double t174 = t20*t93;
	double t210 = t21*t98;
	double t175 = t174-t210;
	double t176 = t46*t175;
	double t177 = t173+t176;
	double t180 = t12*t15*t53*(3.9E1/1.0E2);
	double t181 = t12*t18*t52*(3.9E1/5.0E2);
	double t182 = t11*t12*t15*t53*(3.9E1/5.0E2);
	double t183 = t11*t12*t18*t52*(3.9E1/1.0E2);
	double t213 = t9*t14*t53*(3.9E1/5.0E2);
	double t184 = t180+t181+t182+t183-t213;
	double t186 = t12*t18*t53*(3.9E1/5.0E2);
	double t187 = t9*t14*t52*(3.9E1/5.0E2);
	double t188 = t11*t12*t18*t53*(3.9E1/1.0E2);
	double t214 = t12*t15*t52*(3.9E1/1.0E2);
	double t215 = t11*t12*t15*t52*(3.9E1/5.0E2);
	double t189 = t186+t187+t188-t214-t215;
	double t193 = t19*t122;
	double t194 = t193-t24*t128;
	double t195 = t15*t52*(3.9E1/5.0E2);
	double t196 = t11*t15*t52*(3.9E1/1.0E2);
	double t218 = t18*t53*(3.9E1/1.0E2);
	double t219 = t11*t18*t53*(3.9E1/5.0E2);
	double t197 = t195+t196-t218-t219;
	double t198 = t19*t131;
	double t199 = t15*t53*(3.9E1/5.0E2);
	double t200 = t18*t52*(3.9E1/1.0E2);
	double t201 = t11*t15*t53*(3.9E1/1.0E2);
	double t202 = t11*t18*t52*(3.9E1/5.0E2);
	double t203 = t199+t200+t201+t202;
	double t204 = t198-t24*t140;
	double t205 = t19*t143;
	double t206 = t24*(t50-t192);
	double t207 = t205+t206;
	double t216 = t20*t125;
	double t217 = t216-t21*t212;
	double t220 = t20*t135;
	double t221 = t220-t21*t138;
	double t222 = t21*t145;
	double t223 = t169+t222;
	double t224 = t24*(t102-t106);
	double t225 = t101+t224;
	double t226 = -t77+t83;
	double t227 = -t102+t106;
	double t231 = t24*t227;
	double t228 = t101-t231;
	double t230 = t24*t226;
	double t229 = t82-t230;
	double t232 = t10*t15*t24;
	double t233 = t15*t17*t19*t20;
	double t234 = t12*t18*t19*t21;
	double t235 = t10*t14*t18*t19*t20;
	double t236 = t232+t233+t234+t235-t14*t17*t18*t24;
	double t237 = t19*t226;
	double t238 = t155+t237;
	double t239 = t19*t227;
	double t240 = t157+t239;
	double t241 = t15*t17*t20*t24;
	double t242 = t14*t17*t18*t19;
	double t243 = t12*t18*t21*t24;
	double t244 = t10*t14*t18*t20*t24;
	double t245 = t241+t242+t243+t244-t10*t15*t19;
	double t246 = t15*t17*t21;
	double t247 = t10*t14*t18*t21;
	double t248 = t246+t247-t12*t18*t20;
	J.at(0,0) = -t51*t152-t104*t162+t110*(t156-t80*(t82+t24*t81));
	J.at(0,1) = t51*t172-t110*t167-t104*t177;
	J.at(0,2) = t189*(t132+t141)-t130*t184+t9*t12*t18*(t147-t24*t143)*(3.9E1/1.0E2);
	J.at(0,3) = t203*(t132+t141)-t130*t197+t9*t15*(t147-t24*t143)*(3.9E1/1.0E2);
	J.at(0,4) = t9*t236*(3.9E1/5.0E2);
	J.at(0,5) = t9*t12*t17*t24*(3.9E1/5.0E2)+t9*t14*t19*t21*(3.9E1/5.0E2)+t10*t11*t18*t24*(3.9E1/5.0E2)-t9*t10*t12*t19*t20*(3.9E1/5.0E2)-t11*t12*t15*t19*t21*(3.9E1/5.0E2)+t11*t14*t15*t17*t24*(3.9E1/5.0E2)+t11*t17*t18*t19*t20*(3.9E1/5.0E2)-t10*t11*t14*t15*t19*t20*(3.9E1/5.0E2);
	J.at(1,0) = t150*t152-t158*t162-t154*(t156-t80*t110);
	J.at(1,1) = -t150*t172-t158*t177+t167*(t153-t155);
	J.at(1,2) = t184*t194-t189*t204+t9*t12*t18*t207*(3.9E1/1.0E2);
	J.at(1,3) = t194*t197-t203*t204+t9*t15*t207*(3.9E1/1.0E2);
	J.at(1,4) = t9*t245*(3.9E1/5.0E2);
	J.at(1,5) = t9*t12*t17*t19*(-3.9E1/5.0E2)-t10*t11*t18*t19*(3.9E1/5.0E2)+t9*t14*t21*t24*(3.9E1/5.0E2)-t9*t10*t12*t20*t24*(3.9E1/5.0E2)-t11*t14*t15*t17*t19*(3.9E1/5.0E2)-t11*t12*t15*t21*t24*(3.9E1/5.0E2)+t11*t17*t18*t20*t24*(3.9E1/5.0E2)-t10*t11*t14*t15*t20*t24*(3.9E1/5.0E2);
	J.at(2,0) = t165*(t80*t110-(t65-t105)*(t153-t155))+t152*t170+t175*(t80*t225+t158*(t65-t105));
	J.at(2,1) = t165*t167-t170*t172+t175*t177;
	J.at(2,2) = t184*t217-t189*t221-t9*t12*t18*t223*(3.9E1/1.0E2);
	J.at(2,3) = t197*t217-t203*t221-t9*t15*t223*(3.9E1/1.0E2);
	J.at(2,4) = t9*t248*(3.9E1/5.0E2);
	J.at(2,5) = t9*t14*t20*(-3.9E1/5.0E2)-t9*t10*t12*t21*(3.9E1/5.0E2)+t11*t12*t15*t20*(3.9E1/5.0E2)+t11*t17*t18*t21*(3.9E1/5.0E2)-t10*t11*t14*t15*t21*(3.9E1/5.0E2);
	J.at(3,0) = -t51*t170-t110*t165-t175*t225;
	J.at(3,1) = t29*t51-t226*t229-t227*t228;
	J.at(3,2) = -t35*t51-t69*t229-t93*t228;
	J.at(3,3) = -t61*t229-t91*t228+t9*t18*t51;
	J.at(3,4) = -t11*t51-t9*t52*t229+t9*t53*t228;
	J.at(3,5) = t236;
	J.at(3,6) = -t48+t111;
	J.at(4,0) = t150*t170-t165*t238-t175*t240;
	J.at(4,1) = -t29*t150-t226*t238-t227*t240;
	J.at(4,2) = t35*t150-t69*t238-t93*t240;
	J.at(4,3) = -t61*t238-t91*t240-t9*t18*t150;
	J.at(4,4) = t11*t150-t9*t52*t238+t9*t53*t240;
	J.at(4,5) = t245;
	J.at(4,6) = t150;
	J.at(5,0) = t165*t165+t170*t170+t175*t175;
	J.at(5,1) = -t29*t170+t165*t226+t175*t227;
	J.at(5,2) = t35*t170+t69*t165+t93*t175;
	J.at(5,3) = t61*t165+t91*t175-t9*t18*t170;
	J.at(5,4) = t14*t20+t10*t12*t21;
	J.at(5,5) = t248;
	J.at(5,6) = t170;

}